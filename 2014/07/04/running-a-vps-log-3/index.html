
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->

<head>


<meta charset="utf-8">
<meta http-equiv="cleartype" content="on">

<title>Running a VPS, Log 3: A Mail Server That Works&#8230; Kind Of. - Bits, Bytes, and Words</title>
<meta name="author" content="Jake Zimmerman">




<meta name="description" content="So my mail works now. Kinda.">

<meta name="keywords" content="digitalocean mail summer projects ">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Twitter Cards -->

  
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/images/blue-ring.png"
  
  <meta name="twitter:title" content="Running a VPS, Log 3: A Mail Server that Works... Kind of.">
  <meta name="twitter:description" content="So my mail works now. Kinda.">
  <meta name="twitter:creator" content="@Z1MM32M4N">


<!-- Open Graph -->
<meta property="og:local" content="en_US">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.zimmerman.io/2014/07/04/running-a-vps-log-3">
<meta property="og:title" content="Running a VPS, Log 3: A Mail Server that Works... Kind of.">
<meta property="og:description" content="So my mail works now. Kinda.">

  <meta property="og:image" content="/images/blue-ring.png">

<meta property="og:site_name" content="Bits, Bytes, and Words">

<link rel="canonical" href="https://blog.zimmerman.io/2014/07/04/running-a-vps-log-3">
<link href="/favicon.png" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
<link href="/atom.xml" rel="alternate" title="Bits, Bytes, and Words" type="application/atom+xml">

<script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>
<script>Modernizr || document.write('<script src="/javascripts/vendor/modernizr-2.6.2.custom.min.js"><\/script>') </script>



<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">


</head>

<body id="post" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="/images/avatar-jake.jpg" alt="Jake Zimmerman photo" class="author-photo">
					<h4>Jake Zimmerman</h4>
					<p>Studying computer science at Carnegie Mellon. Working at Dropbox. Previously at Bloomberg L.P.</p>
				</li>
				<li><a href="//www.zimmerman.io">Learn More</a></li>
				<li>
					<a href="mailto:jake@zimmerman.io"><i class="fa fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="https://twitter.com/Z1MM32M4N"><i class="fa fa-twitter"></i> Twitter</a>
				</li>
				<li>
					<a href="https://plus.google.com/+JacobZimmerman0"><i class="fa fa-google-plus"></i> Google+</a>
				</li>
				<li>
					<a href="https://github.com/jez"><i class="fa fa-github"></i> GitHub</a>
				</li>
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="/posts/">All Posts</a></li>
				<li><a href="/categories/">All Categories</a></li>
			</ul>
		</li>
		<li><a href="https://www.zimmerman.io">Portfolio</a></li>
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->



<div class="entry-header">
  
  <div class="entry-image">
    <img src="/images/blue-ring.png" alt="Running a VPS, Log 3: A Mail Server that Works... Kind of.">
  </div><!-- /.entry-image -->
</div><!-- /.entry-header -->


<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="/2014/07/04/running-a-vps-log-3/" rel="bookmark" title="Running a VPS, Log 3: A Mail Server that Works... Kind of.">Running a VPS, Log 3: A Mail Server that Works&#8230; Kind of.</a></h1>
        
        <h2>July 04, 2014</h2>
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <p>After some initial troubles, I finally managed to get basic send and receive functionality  working on my mail server, using EncFS, Dovecot, and Postfix. That being said, it&rsquo;s <em>far</em> from a perfect system, and it needs a good deal more TLC to get it working at a level that&rsquo;s on par with a more &ldquo;professional&rdquo; email service provider. This post details some fixes that I&rsquo;ve implemented so far, as well as the functionality that I&rsquo;ve managed to get working.</p>

<!-- more -->


<h2>EncFS Troubles Revisited</h2>

<p>I mentioned in my <a href="/2014/06/24/running-a-vps-log-2">last log</a> that I had somehow managed to botch my first mail server-related endeavor: installing EncFS, a program for creating encrypted file systems. The way it&rsquo;s supposed to work is depicted below:</p>

<p><a class="image-link" href="/images/encfs.svg"><img src="/images/encfs.svg"></a></p>

<p>Emails originating elsewhere are transfered over the internet to my server according to the DNS settings we&rsquo;ve put in place. These emails need to be stored somewhere upon their receipt; ideally, somewhere encrypted. Thus, the goal is to set up an encrypted file system in user space, such that each incoming email is first stored in <code>/decrypted-mail/</code>, and then is automatically encrypted and stored in <code>/encrypted-mail/</code>. (<strong>Note</strong>: this is not quite how the encryption process works. For more information, you should check out the <a href="https://wiki.archlinux.org/index.php/EncFS">Arch Wiki</a> page on EncFS.)</p>

<p>There are some disadvantages to this type of encryption, most notably that it leaks information about the file system itself. However, as was mentioned in the comments on the <a href="http://sealedabstract.com/code/nsa-proof-your-e-mail-in-2-hours/">tutorial I&rsquo;m working from</a>, &ldquo;if the host/harddisk is given to authorities they cannot decrypt it and thus cannot access your e-mails,&rdquo; which is good enough for me.</p>

<h3>Upgrading the Kernel</h3>

<p>After following the instructions from the tutorial perfectly, <em>and</em> repeating them after having restored from a clean backup, EncFS refused to work. Luckily, I found this <a href="https://github.com/al3x/sovereign/issues/147#issuecomment-43849647">GitHub issue</a> detailing the source of the problem as well as a simple fix for it.</p>

<p>Apparently, my issue was that DigitalOcean doesn&rsquo;t initialize freshly created Debian 7 droplets with the most recent kernel. Unfortunately libfuse, a library used by EncFS to create and manage the encrypted file system, was expecting a more up-to-date kernel version.</p>

<p>Upgrading my kernel version was just a few steps, though. I had to run</p>

<figure class='code'><figcaption><span>Upgrade Kernel </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt-get update
</span><span class='line'><span class="nv">$ </span>sudp apt-get upgrade
</span></code></pre></td></tr></table></div></figure>


<p>to update the list of downloaded kernels, then</p>

<figure class='code'><figcaption><span>Restart </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo shutdown -h now
</span></code></pre></td></tr></table></div></figure>


<p>to tell the server to shutdown and power off. Next up is to switch over the kernel version on the <a href="https://www.digitalocean.com/community/tutorials/how-to-update-a-digitalocean-server-s-kernel-using-the-control-panel">DigitalOcean control panel</a>. All in all, nothing too difficult: the hardest part was that I never expected my problem to have anything to do with DigitalOcean.</p>

<h2>Postfix &amp; Dovecot</h2>

<p>With EncFS finally up and running, I moved on to getting the basic send and receive functionality implemented. For the most part, this process was straight-forward, and is outlined (albeit very scarcely) <a href="http://sealedabstract.com/code/nsa-proof-your-e-mail-in-2-hours/">here</a>.</p>

<p>Then suddenly, the tutorial proclaimed, &ldquo;At this point, it should basically work. You should be able to send and receive mail.&rdquo; I was pretty surprised: I had no idea how to actually go about testing my setup! It simply did not list any way of doing this. It turns out, there are basically three ways to establish a connection with the mail server; I&rsquo;ll discuss the first here, and the others in a [future post][/2014/06/24/running-a-vps-log-4] on troubleshooting problems with my setup.</p>

<h3>Mail Client</h3>

<p>For the true hackers who don&rsquo;t make mistakes and set up their systems perfectly on their first try, simply launching a desktop or mobile mail client and configuring a few account settings, should be enough. Since I&rsquo;m developing on a Mac and was too lazy to install a fancier, potentially more feature-rich client, I&rsquo;m using Mail.app.</p>

<p>A series of dialogs should drive the process of setting up a new user account. My Mail.app setup is shown below.</p>

<p><a class="image-link" href="/images/imap-settings.png"><img src="/images/imap-settings.png"></a></p>

<p>IMAP on my setup works fine, so I&rsquo;ll give some pointers about setting it up correctly:</p>

<ul>
<li><strong>Email Address</strong> or <strong>Username</strong>: Fields that ask for this information should always include a full email address&ndash;in my case <code>jake@zimmerman.io</code>. This is because our MySQL server is configured to store the full address, so Dovecot needs a full address to use to for IMAP authentication.</li>
<li><strong>Password</strong>: This is the password coupled with the email address referenced above, which was SHA512-hashed and stored in the database.</li>
<li><strong>Incoming</strong> or <strong>IMAP Mail Server</strong>: Whatever is in this field needs to eventually resolve to the IP address of our IMAP server. Simply putting the server&rsquo;s IP address directly into this field will suffice. To be more sophisticated though, we&rsquo;ll want to configure this field with a domain name and let our client resolve it, as this is more robust. There are a few ways this can be done; to give a quick overview, you can either set up

<ul>
<li>a CNAME record which resolves to the mail server&rsquo;s IP.</li>
<li>an MX record on the <code>@</code> or apex domain which resolves to the mail server&rsquo;s IP. (This is the option depicted in the screenshot above).</li>
<li>an A record which resolves directly to the mail server&rsquo;s IP.</li>
</ul>
</li>
<li><strong>Port</strong>: 993. We&rsquo;ve configured our server to use SSL to connect over IMAPS, which runs by default over port 993. Be sure to check &ldquo;Use SSL&rdquo; if such an option is available.</li>
</ul>


<p>As far as SMTP goes, this is where my setup starts breaking. I&rsquo;ll come back to why exactly it&rsquo;s failing in more detail <a href="/2014/07/05/running-a-vps-log-4">here</a>, but for now, know that I had to change the line <code>smtpd_tls_auth_only = yes</code> in <code>/etc/postfix/main.cf</code> to <code>... = no</code>, to even get things to work. With this line enabled, credentials are sent over the wire in plain text. Sadly, crypto is hard, and this is the only thing that I have done to manage to get it working.</p>

<p>At this point I could connect to the server &ldquo;zimmerman.io&rdquo; on port 25 using my email with the <em>same</em> password from above. As a side note, this form of authentication is pretty nifty. If you noticed, we&rsquo;re using the same password on IMAP with Dovecot and on SMTP with Postfix. Using the SASL protocol, Postfix can pass on the user&rsquo;s credentials to Dovecot, which then uses its connection to the database to confirm or deny the request for authentication. For a simple, one-user setup, this is a rather elegant solution.</p>

<h2>Debugging a Broken Mail Server</h2>

<p>With SSL authentication turned off, I was able to get Mail.app to send and receive emails. Additionally, I could do the same using the third-party Android client myMail. For whatever reason, the default Android client wouldn&rsquo;t even accept my IMAP login, whereas myMail was smart enough to log me after only asking for my email and password.</p>

<p>Ideally, I&rsquo;d like to have a setup where my password isn&rsquo;t being sent in a format anyone can read. To debug some of these close-to-the-system settings, there are a bunch of <a href="/2014/07/05/running-a-vps-log-4">command line tools</a> which help to inspect exactly what&rsquo;s going wrong with the system.</p>

<hr />

<p><br></p>

<h3>Jake on the Web</h3>

<p><a class="image-link" href="https://pbs.twimg.com/profile_images/463467877593407488/hfwJj20L.jpeg"><img class="left" src="https://pbs.twimg.com/profile_images/463467877593407488/hfwJj20L.jpeg" width="135" height="135"></a>
If you cared enough to read that far, you should consider following me on
<a href="https://www.github.com/jez/">GitHub</a> or paying a visit to <a href="https://www.zimmerman.io/">my homepage</a>. If this post was about one of
my open source projects, make sure to star it on GitHub! I love hearing what
people think, so feel free to comment, open an issue, or send me an email.</p>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="/categories/#digitalocean" title="Pages tagged digitalocean" class="tag">digitalocean</a><a href="/categories/#mail" title="Pages tagged mail" class="tag">mail</a><a href="/categories/#summer projects" title="Pages tagged summer projects" class="tag">summer projects</a></span>
        <span><a href="/2014/07/04/running-a-vps-log-3/" rel="bookmark" title="Running a VPS, Log 3: A Mail Server that Works... Kind of.">Running a VPS, Log 3: A Mail Server that Works&#8230; Kind of.</a> was published on <span class="entry-date date published updated"><time datetime="2014-07-04T13:11:14-05:00">July 04, 2014</time></span></span>
        
        <span class="author vcard"><span class="fn"><a href="https://www.zimmerman.io" title="About Jake Zimmerman">Jake Zimmerman</a></span></span>
        <div class="social-share">
          <ul class="socialcount socialcount-small inline-list">
            <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=/2014/07/04/running-a-vps-log-3/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
            <li class="twitter"><a href="https://twitter.com/intent/tweet?text=/2014/07/04/running-a-vps-log-3/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
            <li class="googleplus"><a href="https://plus.google.com/share?url=/2014/07/04/running-a-vps-log-3/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
          </ul>
        </div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    
      <div class="read-more">
        
          <div class="read-more-header">
            <a href="/2015/03/10/why-zsh/" class="btn">Read More</a>
          </div><!-- /.read-more-header -->
          <div class="read-more-content">
            <h3><a href="/2015/03/10/why-zsh/" title="Why zsh?">Why zsh?</a></h3>
            <p>A short list of reasons why I switched to zsh from bash.
 <a href="/2015/03/10/why-zsh/"> Continue reading</a></p>
          </div><!-- /.read-more-content -->
        
        <div class="read-more-list">
          
            <div class="list-item">
              <h4><a href="/2015/03/10/noteworthy-dotfile-hacks/" title="Noteworthy Dotfile Hacks">Noteworthy Dotfile Hacks</a></h4>
              <span>Published on March 10, 2015</span>
            </div><!-- /.list-item -->
          
            <div class="list-item">
              <h4><a href="/2015/03/09/getting-started-with-rcm/" title="Getting Started with RCM">Getting Started with RCM</a></h4>
              <span>Published on March 09, 2015</span>
            </div><!-- /.list-item -->
          
        </div><!-- /.read-more-list -->
      </div><!-- /.read-more -->
    
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2015 Jake Zimmerman. Powered by <a href="http://octopress.org">Octopress</a> using the <a href="https://github.com/jez/hpstr-theme/">HPSTR Theme for Octopress</a>.</span>

  </footer>
</div><!-- /.footer-wrapper -->


	        
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/javascripts/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/javascripts/octopress.js" type="text/javascript"></script>
<script src="/javascripts/scripts.min.js"></script>
&#8211;>

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-50690546-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>




<script type="text/javascript">
      var disqus_shortname = 'jakez-blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'https://blog.zimmerman.io/2014/07/04/running-a-vps-log-3/';
        var disqus_url = 'https://blog.zimmerman.io/2014/07/04/running-a-vps-log-3/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


	        

</body>
</html>
