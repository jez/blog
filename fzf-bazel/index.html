<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">
<head>
    <meta charset="utf-8" />
  <meta name="generator" content="pandoc-markdown-css-theme" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<meta name="author" content="Jake Zimmerman">
<meta name="dcterms.date" content="2023-08-10 22:57:54 -0400">
<meta name="description" content="I find that the easiest way to work with Bazel is to use fzf.
">
<title>Driving Bazel with fzf ‚Äì Jake Zimmerman</title>

  <link rel="stylesheet" href="/assets/css/theme.css">
<link rel="stylesheet" href="/assets/css/skylighting-solarized-theme.css">




  
    <link rel="apple-touch-icon-precomposed" href="/assets/img/touch-icon.png">
  
    <link rel="icon" sizes="32x32" href="/assets/img/favicon@2x.png">
  
    <link rel="icon" sizes="16x16" href="/assets/img/favicon.png">
  
    <link rel="alternate" type="application/atom+xml" href="/atom.xml">
  
    <link rel="stylesheet" href="/assets/css/extra.css">
  




</head>
<body>
  




  <header>
    <h1 class="title">Driving Bazel with fzf</h1>
    <blockquote class="metadata">
    <p class="date before-toc"><time datetime="2023-08-10 22:57:54 -0400">August 10, 2023</time></p>
    </blockquote>
  </header>


  <nav id="TOC" role="doc-toc">
  <a href="/">‚Üê Return home</a><br>
</nav>

<main>
<p>I find that the easiest way to work with <a href="https://bazel.build">Bazel</a> is with <a href="https://github.com/junegunn/fzf">fzf</a>.</p>
<figure>
<video autoplay muted loop playsinline width="100%">
<source src="/assets/img/fzf-bazel.mp4" type="video/mp4">
</video>
<figcaption>
A demo showing off my Bazel + fzf config (it loops)
</figcaption>
</figure>
<p>If you haven‚Äôt already discovered fzf, it‚Äôs great. It‚Äôs a command-line fuzzy finder, which means you can use it to replace tab completion at the command line with a fuzzy drop-down picker. It‚Äôs straight magic, it‚Äôs quick to set up, and you‚Äôre in for a treat.</p>
<p><a href="https://github.com/junegunn/fzf">Install fzf ‚Üí</a></p>
<p>One of the best parts of fzf is that you can script it.<span class="sidenote-wrapper"><label for="sn-0" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-0" class="margin-toggle"/><span class="marginnote">Fun fzf tip: the <code>kill</code> command is already configured using this completion API: try typing <code>kill -p **&lt;TAB&gt;</code> and you‚Äôll never see <code>kill</code> the same way again üôÇ<br />
<br />
</span></span> In the screen cast above, you see how I‚Äôm using <code>**&lt;TAB&gt;</code> to trigger fzf to list all bazel targets. It uses the <a href="https://github.com/junegunn/fzf#custom-fuzzy-completion">Custom fuzzy completion</a> API to register a shell function to run on <code>TAB</code>.</p>
<p>Here‚Äôs the code you can add to your config files (like your <code>~/.zshrc</code>):</p>
<p><span class="sidenote-wrapper"><label for="sn-1" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-1" class="margin-toggle"/><span class="marginnote">Note: zsh automatically discovers these functions based on their name. But if you‚Äôre using Bash, you need <a href="https://github.com/junegunn/fzf#custom-fuzzy-completion">a few extra lines</a> to register these functions.<br />
<br />
</span></span></p>
<figure>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource zsh numberLines hl-1 hl-6"><code class="sourceCode zsh"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">_fzf_complete_bazel_test()</span> <span class="kw">{</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>  _fzf_complete <span class="st">&#39;-m&#39;</span> <span class="st">&quot;</span><span class="ot">$@</span><span class="st">&quot;</span> <span class="kw">&lt;</span> <span class="kw">&lt;(command</span> bazel query <span class="kw">\</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>    <span class="st">&quot;kind(&#39;(test|test_suite) rule&#39;, //...)&quot;</span> <span class="kw">2&gt;</span> /dev/null<span class="kw">)</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="kw">}</span></span>
<span id="cb1-5"><a href="#cb1-5"></a></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="fu">_fzf_complete_bazel()</span> <span class="kw">{</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>  <span class="kw">local</span> <span class="ot">tokens</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>  <span class="ot">tokens=(</span>$<span class="dt">{(z)LBUFFER}</span><span class="ot">)</span></span>
<span id="cb1-9"><a href="#cb1-9"></a></span>
<span id="cb1-10"><a href="#cb1-10"></a>  <span class="kw">if [</span> <span class="ot">${#tokens[@]}</span> <span class="ot">-ge</span> 3<span class="kw"> ]</span> <span class="kw">&amp;&amp; [</span> <span class="st">&quot;</span><span class="ot">${tokens[2]}</span><span class="st">&quot;</span> <span class="ot">=</span> <span class="st">&quot;test&quot;</span><span class="kw"> ]</span>; <span class="kw">then</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>    _fzf_complete_bazel_test <span class="st">&quot;</span><span class="ot">$@</span><span class="st">&quot;</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>  <span class="kw">else</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>    <span class="co"># Might be able to make this better someday, by listing all repositories</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>    <span class="co"># that have been configured in a WORKSPACE.</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>    <span class="co"># See https://stackoverflow.com/questions/46229831/ or just run</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>    <span class="co">#     bazel query //external:all</span></span>
<span id="cb1-17"><a href="#cb1-17"></a>    <span class="co"># This is the reason why things like @ruby_2_6//:ruby.tar.gz don&#39;t show up</span></span>
<span id="cb1-18"><a href="#cb1-18"></a>    <span class="co"># in the output: they&#39;re not a dep of anything in //..., but they are deps</span></span>
<span id="cb1-19"><a href="#cb1-19"></a>    <span class="co"># of @ruby_2_6//...</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>    _fzf_complete <span class="st">&#39;-m&#39;</span> <span class="st">&quot;</span><span class="ot">$@</span><span class="st">&quot;</span> <span class="kw">&lt;</span> <span class="kw">&lt;(command</span> bazel query --keep_going <span class="kw">\</span></span>
<span id="cb1-21"><a href="#cb1-21"></a>      --noshow_progress <span class="kw">\</span></span>
<span id="cb1-22"><a href="#cb1-22"></a>      <span class="st">&quot;kind(&#39;(binary rule)|(generated file)&#39;, deps(//...))&quot;</span> <span class="kw">2&gt;</span> /dev/null<span class="kw">)</span></span>
<span id="cb1-23"><a href="#cb1-23"></a>  <span class="kw">fi</span></span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="kw">}</span></span></code></pre></div>
<figcaption>
<a href="https://github.com/jez/dotfiles/blob/332c8690538e85eebe72da31d80d6447a8ad082c/util/bazel.zsh#L2-L22">Bazel + fzf config for zsh</a>
</figcaption>
</figure>
<p>At its core, these functions invoke <code>bazel query</code> to list all the targets, and then pass the output to <code>fzf</code> so they can be filtered.</p>
<p>There‚Äôs special handling for <code>bazel</code> (which is usually <code>bazel build</code>) as well as <code>bazel test</code> (which limits the output to only <code>test</code> and <code>test_suite</code> targets).</p>
<p>You can see one caveat in the comment there:<span class="sidenote-wrapper"><label for="sn-2" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-2" class="margin-toggle"/><span class="marginnote">If you have a solution to this, please let me know!<br />
<br />
</span></span> it doesn‚Äôt do all that well at finding every external target. For example, the Sorbet repo has a bunch of <code>:ruby.tar.gz</code> defined in various external (<code>@</code>-prefixed) repository rules, but since Bazel doesn‚Äôt have an easy way to list all those external repos, and because they‚Äôre not transitive deps of anything in <code>//...</code>, they don‚Äôt show up in the output.</p>
<p>One last trick: I have a <em>ton</em> of <a href="https://github.com/jez/dotfiles/blob/20dfe3da792a78c8fdc11756ed2c9c7dce8ac74f/host-jez-pc-01/util/host.sh#L116-L125">bazel shell aliases</a>. Because of how zsh auto-discovers these two <code>_fzf_complete_*</code> functions, using if the first token isn‚Äôt literally <code>bazel</code> then zsh won‚Äôt find the right methods.</p>
<p>That‚Äôs easy enough to fix: just have one more function per alias:</p>
<figure>
<div class="sourceCode" id="cb2"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">_fzf_complete_sb()</span> <span class="kw">{</span> _fzf_complete_bazel <span class="st">&quot;</span><span class="ot">$@</span><span class="st">&quot;</span> <span class="kw">}</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">_fzf_complete_sbg()</span> <span class="kw">{</span> _fzf_complete_bazel <span class="st">&quot;</span><span class="ot">$@</span><span class="st">&quot;</span> <span class="kw">}</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">_fzf_complete_sbgo()</span> <span class="kw">{</span> _fzf_complete_bazel <span class="st">&quot;</span><span class="ot">$@</span><span class="st">&quot;</span> <span class="kw">}</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">_fzf_complete_sbo()</span> <span class="kw">{</span> _fzf_complete_bazel <span class="st">&quot;</span><span class="ot">$@</span><span class="st">&quot;</span> <span class="kw">}</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">_fzf_complete_sbr()</span> <span class="kw">{</span> _fzf_complete_bazel <span class="st">&quot;</span><span class="ot">$@</span><span class="st">&quot;</span> <span class="kw">}</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">_fzf_complete_sbl()</span> <span class="kw">{</span> _fzf_complete_bazel <span class="st">&quot;</span><span class="ot">$@</span><span class="st">&quot;</span> <span class="kw">}</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">_fzf_complete_st()</span> <span class="kw">{</span> _fzf_complete_bazel_test <span class="st">&quot;</span><span class="ot">$@</span><span class="st">&quot;</span> <span class="kw">}</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">_fzf_complete_sto()</span> <span class="kw">{</span> _fzf_complete_bazel_test <span class="st">&quot;</span><span class="ot">$@</span><span class="st">&quot;</span> <span class="kw">}</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">_fzf_complete_stg()</span> <span class="kw">{</span> _fzf_complete_bazel_test <span class="st">&quot;</span><span class="ot">$@</span><span class="st">&quot;</span> <span class="kw">}</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">_fzf_complete_stog()</span> <span class="kw">{</span> _fzf_complete_bazel_test <span class="st">&quot;</span><span class="ot">$@</span><span class="st">&quot;</span> <span class="kw">}</span></span></code></pre></div>
<figcaption>
<a href="https://github.com/jez/dotfiles/blob/332c8690538e85eebe72da31d80d6447a8ad082c/util/bazel.zsh#L25-L34">All the aliases</a>
</figcaption>
</figure>
<p>And that about sums it up. If you have tips for how I could improve these functions, please let me know!</p>
</main>


    <footer class="signoff">
      <p>
        More like this:
        
          <span class="smallcaps"><strong><a href="/categories/#bash">bash</a></strong></span>, 
        
          <span class="smallcaps"><strong><a href="/categories/#zsh">zsh</a></strong></span>, 
        
          <span class="smallcaps"><strong><a href="/categories/#dotfiles">dotfiles</a></strong></span>, 
        
          <span class="smallcaps"><strong><a href="/categories/#bazel">bazel</a></strong></span>
        
      </p>
      <p><a href="/">‚Üê Return home</a></p>
    </footer>
  
    <script src="/assets/js/enable_checkboxes.js"></script>

  



</body>
</html>

