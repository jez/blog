<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">
<head>
    <meta charset="utf-8" />
  <meta name="generator" content="pandoc-markdown-css-theme" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<meta name="author" content="Jake Zimmerman">
<meta name="dcterms.date" content="2020-07-21 18:40:23 -0400">
<meta name="description" content="I've managed to get LSP-based IDE features powered by clangd working for the Ruby VM's source code (in my case, in Vim). Here's how I did it!
">
<title>Exploring Ruby with clangd – Jake Zimmerman</title>

  <link rel="stylesheet" href="/assets/css/theme.css">
<link rel="stylesheet" href="/assets/css/skylighting-solarized-theme.css">




  
    <link rel="apple-touch-icon-precomposed" href="/assets/img/touch-icon.png">
  
    <link rel="icon" sizes="32x32" href="/assets/img/favicon@2x.png">
  
    <link rel="icon" sizes="16x16" href="/assets/img/favicon.png">
  
    <link rel="alternate" type="application/atom+xml" href="/atom.xml">
  
    <link rel="stylesheet" href="/assets/css/extra.css">
  




</head>
<body>
  




  <header>
    <h1 class="title">Exploring Ruby with clangd</h1>
    <blockquote class="metadata">
    <p class="date before-toc"><time datetime="2020-07-21 18:40:23 -0400">July 21, 2020</time></p>
    </blockquote>
  </header>


  <nav id="TOC" role="doc-toc">
  <a href="/">Home</a><br>
  <strong>Contents</strong><label for="contents">⊕</label>
  <input type="checkbox" id="contents">
  <ul>
  <li><a href="#steps" id="toc-steps">Steps</a>
  <ul>
  <li><a href="#install-bear" id="toc-install-bear">1. Install
  Bear</a></li>
  <li><a href="#clone-the-ruby-source-code."
  id="toc-clone-the-ruby-source-code.">2. Clone the Ruby source
  code.</a></li>
  <li><a href="#configure-the-ruby-build."
  id="toc-configure-the-ruby-build.">3. Configure the Ruby
  build.</a></li>
  <li><a href="#use-bear-to-invoke-make"
  id="toc-use-bear-to-invoke-make">4. Use <code>bear</code> to invoke
  <code>make</code></a></li>
  <li><a href="#thats-it" id="toc-thats-it">5. That’s it!</a></li>
  </ul></li>
  <li><a href="#appendix-building-bear-from-source"
  id="toc-appendix-building-bear-from-source">Appendix: Building Bear
  from source</a></li>
  <li><a href="#appendix-lsp-in-neovim-with-languageclient-neovim"
  id="toc-appendix-lsp-in-neovim-with-languageclient-neovim">Appendix:
  LSP in Neovim with LanguageClient-neovim</a></li>
  </ul>
</nav>

<main>
<p>I’ve managed to get LSP-based IDE features powered by <a
href="https://clangd.llvm.org/">clangd</a> working for the Ruby VM’s
source code (in my case, in Vim). Here’s how I did it!</p>
<!-- more -->
<p>I’ve been making a point to learn more about <a
href="/search-down-the-stack/">things I depend on</a> recently. Today,
that means learning about Ruby. And what better way to learn than to
check out the source code, and jump around?</p>
<p><a href="https://clangd.llvm.org/">clangd</a> is an editor-agnostic
language server that uses the <a href="https://langserver.org/">Language
Server Protocol</a> to power IDE-like features in your preferred text
editor. All it needs is a <code>compile_commands.json</code>, which is
basically a mapping of filename to options to pass to <code>clang</code>
so that it knows things like which warnings to enable and where to
search for header files.</p>
<p><a href="https://clangd.llvm.org/">clangd</a> works best for projects
built using <code>cmake</code>, but the Ruby VM doesn’t use
<code>cmake</code>. Regardless, we can make a
<code>compile_commands.json</code> file by using <a
href="https://github.com/rizsotto/Bear">Bear</a> to trace the execution
of a Ruby build, and use the trace information to write out a
<code>compile_commands.json</code> file.</p>
<h1 id="steps">Steps</h1>
<p>I could only get these steps to work for Linux, as the Bear README
mentions that on macOS you have to disable System Integrity Protection
to get it to work.</p>
<h2 id="install-bear">1. Install <a
href="https://github.com/rizsotto/Bear">Bear</a></h2>
<p>I describe how I built Bear from source in the Appendix.</p>
<h2 id="clone-the-ruby-source-code.">2. Clone the Ruby source code.</h2>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/ruby/ruby</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ruby</span></code></pre></div>
<h2 id="configure-the-ruby-build.">3. Configure the Ruby build.</h2>
<p>We have to tell the <code>configure</code> script to use Clang to
compile (or if you’re confident that your system compiler toolchain is
Clang, you can just run <code>./configure</code>).</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the ./configure file</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">autoconf</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># This only works when using clang to build Ruby</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span> CC=clang</span></code></pre></div>
<h2 id="use-bear-to-invoke-make">4. Use <code>bear</code> to invoke
<code>make</code></h2>
<p>Bear will use a dynamically preloaded library to trace system calls
that exec <code>clang</code> processes, looking at things like the
command line arguments given to Clang.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bear</span> make</span></code></pre></div>
<h2 id="thats-it">5. That’s it!</h2>
<p>The output is <code>./compile_commands.json</code>, which should be
non-empty. If it’s empty or just has <code>[]</code>, it didn’t work.
There’s some troubleshooting in the <a
href="https://github.com/rizsotto/Bear">Bear</a> README.</p>
<p>The <code>compile_commands.json</code> file will be consumed by
<code>clangd</code> in your editor. Check <a
href="https://langserver.org" class="uri">https://langserver.org</a> to
find an LSP client for your preferred editor, and follow its setup
instructions.</p>
<p>Once you’ve built the <code>compile_commands.json</code> file and
configured your editor to use LSP with <code>clangd</code>, you should
be able to do things like Jump to Definition and Hover on the Ruby
source code!</p>
<h1 id="appendix-building-bear-from-source">Appendix: Building Bear from
source</h1>
<p>This is probably common knowledge for people who use
<code>cmake</code> regularly, but this is how I built Bear from source,
because I built it on a machine where I didn’t have root so I couldn’t
write to <code>/usr/local</code>.</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/rizsotto/Bear</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> Bear</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> build</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> build</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Install to $HOME/.local/bin instead of /usr/local/bin</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cmake</span> .. <span class="st">&quot;-DCMAKE_INSTALL_PREFIX=</span><span class="va">$HOME</span><span class="st">/.local&quot;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> <span class="at">-j</span><span class="va">$(</span><span class="fu">nproc</span><span class="va">)</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># → $HOME/.local/bin/bear exists now</span></span></code></pre></div>
<h1 id="appendix-lsp-in-neovim-with-languageclient-neovim">Appendix: LSP
in Neovim with LanguageClient-neovim</h1>
<p>I use Neovim. My preferred LSP client is <a
href="https://github.com/autozimu/LanguageClient-neovim">LanguageClient-neovim</a>.
Here’s the parts of my Neovim config files that setup
<code>clangd</code>:</p>
<p><a
href="https://github.com/jez/dotfiles/blob/865a74d93d8ab1c28713ae0dcd53797b6c26dc6a/vim/plug-settings.vim#L576-L587">→
<code>vim/plug-settings.vim</code> in jez/dotfiles</a></p>
</main>


    <footer class="signoff">
      <p>
        More like this:
        
          <span class="smallcaps"><strong><a href="/categories/#ruby">ruby</a></strong></span>, 
        
          <span class="smallcaps"><strong><a href="/categories/#vim">vim</a></strong></span>, 
        
          <span class="smallcaps"><strong><a href="/categories/#debugging">debugging</a></strong></span>
        
      </p>
      <p><a href="/">← Return home</a></p>
    </footer>
  
    <script src="/assets/js/enable_checkboxes.js"></script>

  



</body>
</html>

